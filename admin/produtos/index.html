<!DOCTYPE html>
<html lang="pt-br">
<head>
    <link rel="icon" type="image/svg+xml" href="../../images/logo-vetorizada-nobg.svg">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produtos - Admin</title>
    <link rel="stylesheet" href="../../style/style-admin.css">
</head>

<body>
    <!-- Conte√∫do (hidden until auth validated) -->
    <div class="content" style="display:none;">
        <div class="topbar">
            <h1>Produtos</h1>
            <div class="search">
                <input type="text" id="searchInput" placeholder="Buscar produtos..." onkeyup="filterTable()">
            </div>
            <div class="actions">
                <button onclick="deleteSelected()">Excluir</button>
                <button onclick="editSelected()">Editar</button>
                <button onclick="openAddModal()">Adicionar</button>
                <button onclick="window.location.href='../'">Voltar ao Menu</button>
                <button class="btn-sair" onclick="logout()">Sair</button>
            </div>
        </div>

        <div class="grid">
            <!-- Tabela de Produtos -->
            <div class="card" style="flex: 1 1 100%;">
                <div class="card-header">Lista de Produtos</div>
                <div class="card-body">
                    <div class="table-container">
                        <table id="produtosTable">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" onchange="selectAll(this)"></th>
                                    <th>ID</th>
                                    <th>Nome</th>
                                    <th>Pre√ßo</th>
                                    <th>Estoque</th>
                                    <th>Imagens</th>
                                </tr>
                            </thead>
                            <tbody id="produtosBody">
                                <tr>
                                    <td colspan="7" class="loading">Carregando dados...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="produtoPagination">
                        <button onclick="changePage('first')" id="firstBtn">&laquo;</button>
                        <button onclick="changePage('prev')" id="prevBtn">&lt;</button>
                        <span id="pageInfo">1 de 1</span>
                        <button onclick="changePage('next')" id="nextBtn">&gt;</button>
                        <button onclick="changePage('last')" id="lastBtn">&raquo;</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para adicionar/editar produto -->
        <div class="modal" id="produtoModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">Adicionar Produto</h2>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="editImageSection" style="display: none; margin-bottom: 25px;">
                        <h3 style="color: #17385a; font-size: 16px; margin-bottom: 15px;">Imagens Atuais</h3>
                        <div id="currentImagesContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px;"></div>
                    </div>
                    <form id="produtoForm">
                        <div class="form-group">
                            <label for="produtoNome">Nome do Produto</label>
                            <input type="text" id="produtoNome" placeholder="Digite o nome do produto" required>
                        </div>
                        <div class="form-group">
                            <label for="produtoPreco">Pre√ßo (R$)</label>
                            <input type="number" id="produtoPreco" step="0.01" placeholder="0.00" required>
                        </div>
                        <div class="form-group">
                            <label for="produtoEstoque">Estoque</label>
                            <input type="number" id="produtoEstoque" placeholder="Quantidade em estoque" required>
                        </div>
                        <div class="form-group">
                            <label for="produtoImagens">Imagens do Produto (m√°ximo 5)</label>
                            <input type="file" id="produtoImagens" accept="image/*" multiple>
                            <small style="color: #64748b; margin-top: 5px; display: block;">Selecione at√© 5 imagens</small>
                            <div id="imagePreviewContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 15px;"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                    <button class="btn btn-primary" onclick="saveProduto()">Salvar</button>
                </div>
            </div>
        </div>

        <!-- Modal para visualizar imagens -->
        <div class="modal" id="imagemModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Imagens do Produto</h2>
                    <button class="modal-close" onclick="closeImageModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="imagemGallery" class="image-gallery"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeImageModal()">Fechar</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        var TOKEN_KEY = 'token';
        const API_URL = 'https://api-nr.vercel.app/api';
        
        // Pagination state
        let currentPage = 1;
        const itemsPerPage = 10;
        let allProdutos = [];
        let editingId = null;

        function logout() {
            try { localStorage.removeItem(TOKEN_KEY); } catch (e) { console.warn('Could not remove token', e); }
            window.location.href = '../../login';
        }

        function selectAll(checkbox) {
            const checkboxes = document.querySelectorAll('#produtosTable tbody input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
        }

        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allProdutos.filter(p => 
                p.nome?.toLowerCase().includes(searchTerm)
            );
            
            currentPage = 1;
            renderProdutos(filtered);
        }

        function renderProdutos(data = allProdutos) {
            const tbody = document.getElementById('produtosBody');
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = data.slice(start, end);
            const totalPages = Math.ceil(data.length / itemsPerPage) || 1;
            
            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">üì¶</div><div class="empty-state-text">Nenhum produto encontrado</div><div class="empty-state-subtext">Adicione produtos para come√ßar</div></td></tr>';
            } else {
                tbody.innerHTML = pageData.map(prod => `
                    <tr>
                        <td><input type="checkbox" data-id="${prod.id}"></td>
                        <td>${prod.id}</td>
                        <td>${prod.nome || 'N/A'}</td>
                        <td>R$ ${parseFloat(prod.preco || 0).toFixed(2)}</td>
                        <td>${prod.estoque || 0}</td>
                        <td><a href="#" class="view-images-link" onclick="viewImages(${prod.id}); return false;">Visualizar</a></td>
                    </tr>
                `).join('');
            }
            
            document.getElementById('pageInfo').textContent = `${currentPage} de ${totalPages}`;
            document.getElementById('firstBtn').disabled = currentPage === 1;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
            document.getElementById('lastBtn').disabled = currentPage === totalPages;
        }

        function changePage(action) {
            const totalPages = Math.ceil(allProdutos.length / itemsPerPage);
            
            if (action === 'first') currentPage = 1;
            else if (action === 'prev' && currentPage > 1) currentPage--;
            else if (action === 'next' && currentPage < totalPages) currentPage++;
            else if (action === 'last') currentPage = totalPages;
            
            renderProdutos();
        }

        function openAddModal() {
            editingId = null;
            window.imagensToRemove = [];
            document.getElementById('modalTitle').textContent = 'Adicionar Produto';
            document.getElementById('produtoForm').reset();
            document.getElementById('imagePreviewContainer').innerHTML = '';
            document.getElementById('editImageSection').style.display = 'none';
            document.getElementById('produtoModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('produtoModal').classList.remove('active');
            editingId = null;
            window.imagensToRemove = [];
        }

        function viewImages(produtoId) {
            const produto = allProdutos.find(p => p.id == produtoId);
            if (!produto) return;

            const gallery = document.getElementById('imagemGallery');
            const imagens = produto.imagens || [];

            if (imagens.length === 0) {
                gallery.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üñºÔ∏è</div><div class="empty-state-text">Nenhuma imagem dispon√≠vel</div></div>';
            } else {
                gallery.innerHTML = imagens.map(url => `
                    <div class="gallery-item">
                        <img src="${url}" alt="Imagem do produto" onerror="this.src='https://via.placeholder.com/300x300?text=Imagem+Indispon√≠vel'">
                    </div>
                `).join('');
            }

            document.getElementById('imagemModal').classList.add('active');
        }

        function closeImageModal() {
            document.getElementById('imagemModal').classList.remove('active');
        }

        async function saveProduto() {
            const form = document.getElementById('produtoForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const fileInput = document.getElementById('produtoImagens');
            const files = fileInput.files;

            if (files.length > 5) {
                alert('Voc√™ pode selecionar no m√°ximo 5 imagens');
                return;
            }

            // Check if editing and validate images
            if (editingId) {
                const produto = allProdutos.find(p => p.id == editingId);
                if (produto) {
                    const currentImagesCount = (produto.imagens || []).length;
                    const imagesToRemoveCount = (window.imagensToRemove || []).length;
                    const newImagesCount = files.length;
                    const remainingImages = currentImagesCount - imagesToRemoveCount + newImagesCount;
                    
                    if (remainingImages === 0) {
                        alert('O produto deve ter pelo menos uma imagem. Adicione novas imagens ou n√£o remova todas as imagens existentes.');
                        return;
                    }
                }
            }

            const formData = new FormData();
            formData.append('nome', document.getElementById('produtoNome').value);
            formData.append('preco', document.getElementById('produtoPreco').value);
            formData.append('estoque', document.getElementById('produtoEstoque').value || '0');

            // Add image files to FormData
            for (let i = 0; i < files.length; i++) {
                formData.append('imagens', files[i]);
            }

            const token = localStorage.getItem(TOKEN_KEY);
            
            try {
                let response;
                if (editingId) {
                    // Edit mode - PUT request
                    // Add images to remove if any
                    if (window.imagensToRemove && window.imagensToRemove.length > 0) {
                        formData.append('imagensToRemove', JSON.stringify(window.imagensToRemove));
                    }

                    response = await fetch(`${API_URL}/admin/produtos/${editingId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': 'Bearer ' + token
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || `Erro ao editar produto: ${response.status}`);
                    }

                    alert('Produto editado com sucesso!');
                } else {
                    // Add mode - POST request
                    response = await fetch(`${API_URL}/admin/produtos`, {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + token
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || `Erro ao adicionar produto: ${response.status}`);
                    }

                    alert('Produto adicionado com sucesso!');
                }

                const data = await response.json();
                closeModal();
                await loadData();
            } catch (error) {
                console.error('Erro ao salvar produto:', error);
                alert('Erro ao salvar produto: ' + error.message);
            }
        }

        function editSelected() {
            const checked = Array.from(document.querySelectorAll('#produtosTable tbody input:checked'));
            
            if (checked.length === 0) {
                alert('Selecione um produto para editar');
                return;
            }
            
            if (checked.length > 1) {
                alert('Selecione apenas um produto para editar');
                return;
            }

            const produtoId = checked[0].dataset.id;
            const produto = allProdutos.find(p => p.id == produtoId);
            
            if (produto) {
                editingId = produtoId;
                window.imagensToRemove = [];
                document.getElementById('modalTitle').textContent = 'Editar Produto';
                document.getElementById('produtoNome').value = produto.nome;
                document.getElementById('produtoPreco').value = produto.preco;
                document.getElementById('produtoEstoque').value = produto.estoque;
                
                // Show current images section
                const editImageSection = document.getElementById('editImageSection');
                const currentImagesContainer = document.getElementById('currentImagesContainer');
                
                if (produto.imagens && produto.imagens.length > 0) {
                    editImageSection.style.display = 'block';
                    currentImagesContainer.innerHTML = produto.imagens.map((url, index) => `
                        <div class="current-image-item" data-url="${url}" style="position: relative; border: 2px solid #e2e8f0; border-radius: 10px; overflow: hidden;">
                            <img src="${url}" alt="Imagem ${index + 1}" style="width: 100%; height: 120px; object-fit: cover; display: block;" onerror="this.src='https://via.placeholder.com/120x120?text=Erro'">
                            <button type="button" onclick="markImageForRemoval('${url}')" style="position: absolute; top: 5px; right: 5px; background: #dc2626; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.3);" title="Excluir imagem">&times;</button>
                        </div>
                    `).join('');
                } else {
                    editImageSection.style.display = 'none';
                }
                
                // Clear file input and preview
                document.getElementById('produtoImagens').value = '';
                document.getElementById('imagePreviewContainer').innerHTML = '';
                
                document.getElementById('produtoModal').classList.add('active');
            }
        }

        async function deleteSelected() {
            const checked = Array.from(document.querySelectorAll('#produtosTable tbody input:checked')).map(cb => cb.dataset.id);
            
            if (checked.length === 0) {
                alert('Selecione pelo menos um produto para excluir');
                return;
            }
            
            if (!confirm(`Deseja realmente excluir ${checked.length} produto(s)?`)) {
                return;
            }

            const token = localStorage.getItem(TOKEN_KEY);
            const deletePromises = checked.map(id => 
                fetch(`${API_URL}/admin/produtos/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Accept': 'application/json'
                    }
                })
            );

            try {
                const results = await Promise.all(deletePromises);
                const failures = results.filter(r => !r.ok);
                
                if (failures.length > 0) {
                    alert(`Erro ao excluir ${failures.length} produto(s). Verifique o console para detalhes.`);
                    console.error('Falhas na exclus√£o:', failures);
                } else {
                    alert(`${checked.length} produto(s) exclu√≠do(s) com sucesso!`);
                }
                
                // Reload data
                await loadData();
            } catch (error) {
                console.error('Erro ao excluir produtos:', error);
                alert('Erro ao excluir produtos. Tente novamente.');
            }
        }

        function markImageForRemoval(imageUrl) {
            if (!confirm('Marcar esta imagem para exclus√£o?')) {
                return;
            }

            // Initialize array if not exists
            if (!window.imagensToRemove) {
                window.imagensToRemove = [];
            }

            // Add to removal list
            if (!window.imagensToRemove.includes(imageUrl)) {
                window.imagensToRemove.push(imageUrl);
            }

            // Find and mark the image visually
            const imageItems = document.querySelectorAll('.current-image-item');
            imageItems.forEach(item => {
                if (item.dataset.url === imageUrl) {
                    item.style.opacity = '0.4';
                    item.style.border = '2px solid #dc2626';
                    const button = item.querySelector('button');
                    if (button) {
                        button.textContent = '‚Ü∫';
                        button.title = 'Restaurar imagem';
                        button.style.background = '#16a34a';
                        button.onclick = () => unmarkImageForRemoval(imageUrl);
                    }
                }
            });
        }

        function unmarkImageForRemoval(imageUrl) {
            // Remove from removal list
            if (window.imagensToRemove) {
                window.imagensToRemove = window.imagensToRemove.filter(url => url !== imageUrl);
            }

            // Restore visual state
            const imageItems = document.querySelectorAll('.current-image-item');
            imageItems.forEach(item => {
                if (item.dataset.url === imageUrl) {
                    item.style.opacity = '1';
                    item.style.border = '2px solid #e2e8f0';
                    const button = item.querySelector('button');
                    if (button) {
                        button.textContent = '√ó';
                        button.title = 'Excluir imagem';
                        button.style.background = '#dc2626';
                        button.onclick = () => markImageForRemoval(imageUrl);
                    }
                }
            });
        }

        async function loadData() {
            const token = localStorage.getItem(TOKEN_KEY);
            
            try {
                const response = await fetch('https://api-nr.vercel.app/api/produtos', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Normalize data: ensure preco is a number and imagens is an array
                allProdutos = data.map(produto => ({
                    id: produto.id,
                    nome: produto.nome,
                    preco: typeof produto.preco === 'string' ? parseFloat(produto.preco) : produto.preco,
                    estoque: produto.estoque,
                    imagens: Array.isArray(produto.imagens) ? produto.imagens : []
                }));
                
                renderProdutos();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                document.getElementById('produtosBody').innerHTML = '<tr><td colspan="6"><div class="alert alert-error">Erro ao carregar produtos. Tente novamente.</div></td></tr>';
            }
        }

        // Handle file input preview
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('produtoImagens');
            const previewContainer = document.getElementById('imagePreviewContainer');
            
            fileInput.addEventListener('change', function(e) {
                const files = e.target.files;
                
                if (files.length > 5) {
                    alert('Voc√™ pode selecionar no m√°ximo 5 imagens');
                    this.value = '';
                    previewContainer.innerHTML = '';
                    return;
                }
                
                previewContainer.innerHTML = '';
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        const div = document.createElement('div');
                        div.style.cssText = 'position: relative; border: 2px solid #e2e8f0; border-radius: 8px; overflow: hidden;';
                        div.innerHTML = `
                            <img src="${event.target.result}" style="width: 100%; height: 100px; object-fit: cover; display: block;">
                            <div style="padding: 5px; background: #f8fafc; font-size: 11px; text-align: center; color: #64748b; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${file.name}</div>
                        `;
                        previewContainer.appendChild(div);
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
        });

        (function validateAuthAndInit() {
            const AUTH_URL = API_URL + '/auth/perfil';

            const token = localStorage.getItem(TOKEN_KEY);
            if (!token) {
                window.location.href = '../../login';
                return;
            }

            fetch(AUTH_URL, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Unauthorized');
                return response.json();
            })
            .then(data => {
                // Reveal UI
                const content = document.querySelector('.content');
                if (content) content.style.display = '';

                // Load data
                loadData();
            })
            .catch(err => {
                console.error('Auth validation failed:', err);
                try { localStorage.removeItem(TOKEN_KEY); } catch (e) {}
                window.location.href = '../../login';
            });
        })();
    </script>
</body>
</html>