<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <link rel="icon" type="image/svg+xml" href="../../images/logo-vetorizada-nobg.svg">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Credenciais - Painel Administrativo</title>
        <link rel="stylesheet" href="../../style/style-admin.css">
        <style>
            .profile-container {
                max-width: 1100px;
                margin: 0 auto;
                padding: 0 20px;
            }

            @media (max-width: 968px) {
                .profile-container {
                    max-width: 700px;
                }
            }

            .profile-card {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 16px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
                overflow: hidden;
            }

            .profile-header {
                background: linear-gradient(135deg, #17385a 0%, #2a5f7e 100%);
                color: #ffffff;
                padding: 30px;
                text-align: center;
            }

            .profile-header h2 {
                font-size: 24px;
                font-weight: 700;
                margin: 0;
            }

            .profile-body {
                padding: 30px;
                display: grid;
                grid-template-columns: 1fr auto 1fr;
                gap: 40px;
                align-items: start;
            }

            @media (max-width: 968px) {
                .profile-body {
                    grid-template-columns: 1fr;
                    gap: 30px;
                }
            }

            .profile-section {
                display: flex;
                flex-direction: column;
                min-width: 0;
                overflow: hidden;
            }

            .vertical-divider {
                width: 2px;
                height: 100%;
                min-height: 300px;
                background: linear-gradient(
                    to bottom,
                    transparent 0%,
                    #cbd5e1 10%,
                    #94a3b8 50%,
                    #cbd5e1 90%,
                    transparent 100%
                );
                position: relative;
                align-self: stretch;
            }

            .vertical-divider::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 8px;
                height: 8px;
                background: #17385a;
                border-radius: 50%;
                box-shadow: 0 0 0 3px rgba(23, 56, 90, 0.1);
            }

            @media (max-width: 968px) {
                .vertical-divider {
                    display: none;
                }
            }

            .section-title {
                color: #17385a;
                font-size: 18px;
                font-weight: 700;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 2px solid #e2e8f0;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .section-title svg {
                width: 20px;
                height: 20px;
                color: #17385a;
                flex-shrink: 0;
            }

            .section-divider {
                width: 1px;
                background: linear-gradient(to bottom, transparent, #e2e8f0 20%, #e2e8f0 80%, transparent);
                grid-column: 2;
                grid-row: 1;
            }

            @media (max-width: 968px) {
                .section-divider {
                    width: 100%;
                    height: 1px;
                    background: linear-gradient(to right, transparent, #e2e8f0 20%, #e2e8f0 80%, transparent);
                    grid-column: 1;
                    margin: 10px 0;
                }
            }

            .form-group input:disabled {
                background: #f1f5f9;
                color: #64748b;
                cursor: not-allowed;
            }

            .email-info {
                display: flex;
                align-items: center;
                gap: 8px;
                color: #64748b;
                font-size: 13px;
                margin-top: 6px;
            }

            .email-info svg {
                width: 14px;
                height: 14px;
                flex-shrink: 0;
            }

            .btn-container {
                display: flex;
                justify-content: flex-end;
                margin-top: 10px;
            }

            .password-section {
                margin-top: 10px;
            }

            .message {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 20px;
                border-radius: 12px;
                font-size: 14px;
                font-weight: 500;
                display: none;
                z-index: 9999;
                min-width: 300px;
                max-width: 400px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                animation: slideIn 0.3s ease-out;
                word-wrap: break-word;
            }

            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }

            .message.success {
                background: #dcfce7;
                color: #166534;
                border: 1px solid #bbf7d0;
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .message.error {
                background: #fef2f2;
                color: #dc2626;
                border: 1px solid #fecaca;
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .message::before {
                content: '';
                width: 20px;
                height: 20px;
                flex-shrink: 0;
                background-size: contain;
                background-repeat: no-repeat;
            }

            .message.success::before {
                background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23166534" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>');
            }

            .message.error::before {
                background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23dc2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>');
            }

            .message.hiding {
                animation: slideOut 0.3s ease-in forwards;
            }

            .back-link {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                color: #ffffff;
                text-decoration: none;
                font-weight: 600;
                font-size: 14px;
                margin-bottom: 20px;
                padding: 10px 20px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 10px;
                transition: all 0.3s ease;
            }

            .back-link:hover {
                background: rgba(255, 255, 255, 0.2);
                transform: translateX(-3px);
            }

            .password-toggle {
                position: relative;
            }

            .password-toggle input {
                padding-right: 45px;
            }

            .toggle-visibility {
                position: absolute;
                right: 12px;
                top: 50%;
                transform: translateY(-50%);
                background: none;
                border: none;
                cursor: pointer;
                color: #94a3b8;
                padding: 5px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: color 0.3s ease;
            }

            .toggle-visibility:hover {
                color: #17385a;
            }

            .toggle-visibility svg {
                width: 20px;
                height: 20px;
            }
        </style>
    </head>

    <body>
    <!-- Conteúdo (hidden until auth validated) -->
    <div class="content" style="display:none;">

        <a href="../admin" class="back-link">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Voltar ao Painel
        </a>

        <div class="profile-container">
            <div class="profile-card">
                <div class="profile-header">
                    <h2>Minhas Credenciais</h2>
                </div>

                <div class="profile-body">
                    <!-- Left Section: User Info -->
                    <div class="profile-section">
                        <h3 class="section-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                            Informações do Usuário
                        </h3>
                        
                        <form id="formUserInfo">
                            <div class="form-group">
                                <label for="username">Usuário</label>
                                <input type="text" id="username" name="username" placeholder="Seu nome de usuário" required>
                            </div>

                            <div class="form-group">
                                <label for="email">E-mail</label>
                                <input type="email" id="email" name="email" placeholder="Seu e-mail" required>
                            </div>

                            <div class="form-group">
                                <label for="userPassword">Senha Atual (obrigatória para salvar)</label>
                                <div class="password-toggle">
                                    <input type="password" id="userPassword" name="userPassword" placeholder="Digite sua senha atual" required>
                                    <button type="button" class="toggle-visibility" onclick="togglePassword('userPassword', this)">
                                        <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                            <circle cx="12" cy="12" r="3"/>
                                        </svg>
                                        <svg class="eye-closed" style="display:none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                            <line x1="1" y1="1" x2="23" y2="23"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <div class="btn-container">
                                <button type="submit" class="btn btn-primary">Salvar Usuário</button>
                            </div>
                        </form>
                    </div>

                    <!-- Vertical Divider -->
                    <div class="vertical-divider"></div>

                    <!-- Right Section: Change Password -->
                    <div class="profile-section">
                        <h3 class="section-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                            Alterar Senha
                        </h3>

                        <form id="formPassword" class="password-section">
                            <div class="form-group">
                                <label for="currentPassword">Senha Atual</label>
                                <div class="password-toggle">
                                    <input type="password" id="currentPassword" name="currentPassword" placeholder="Digite sua senha atual" required>
                                    <button type="button" class="toggle-visibility" onclick="togglePassword('currentPassword', this)">
                                        <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                            <circle cx="12" cy="12" r="3"/>
                                        </svg>
                                        <svg class="eye-closed" style="display:none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                            <line x1="1" y1="1" x2="23" y2="23"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="newPassword">Nova Senha</label>
                                <div class="password-toggle">
                                    <input type="password" id="newPassword" name="newPassword" placeholder="Digite sua nova senha" required>
                                    <button type="button" class="toggle-visibility" onclick="togglePassword('newPassword', this)">
                                        <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                            <circle cx="12" cy="12" r="3"/>
                                        </svg>
                                        <svg class="eye-closed" style="display:none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                            <line x1="1" y1="1" x2="23" y2="23"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="confirmPassword">Confirmar Nova Senha</label>
                                <div class="password-toggle">
                                    <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirme sua nova senha" required>
                                    <button type="button" class="toggle-visibility" onclick="togglePassword('confirmPassword', this)">
                                        <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                            <circle cx="12" cy="12" r="3"/>
                                        </svg>
                                        <svg class="eye-closed" style="display:none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                            <line x1="1" y1="1" x2="23" y2="23"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <div class="btn-container">
                                <button type="submit" class="btn btn-primary">Alterar Senha</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Message containers (fixed position) -->
    <div id="messageUser" class="message"></div>
    <div id="messagePassword" class="message"></div>

    <script>
        var TOKEN_KEY = 'token';
        const API_URL = 'https://api-nr.vercel.app/api';

        // Toggle password visibility
        function togglePassword(inputId, btn) {
            const input = document.getElementById(inputId);
            const eyeOpen = btn.querySelector('.eye-open');
            const eyeClosed = btn.querySelector('.eye-closed');

            if (input.type === 'password') {
                input.type = 'text';
                eyeOpen.style.display = 'none';
                eyeClosed.style.display = 'block';
            } else {
                input.type = 'password';
                eyeOpen.style.display = 'block';
                eyeClosed.style.display = 'none';
            }
        }

        // Show message
        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            
            // Clear any existing timeout
            if (el.hideTimeout) {
                clearTimeout(el.hideTimeout);
            }
            
            // Remove hiding class if present
            el.classList.remove('hiding');
            
            // Set message content and type
            el.textContent = message;
            el.className = 'message ' + type;
            
            // Auto-hide after 5 seconds with animation
            el.hideTimeout = setTimeout(() => {
                el.classList.add('hiding');
                
                // Remove completely after animation
                setTimeout(() => {
                    el.className = 'message';
                }, 300);
            }, 5000);
        }

        // Logout function
        function logout() {
            try { localStorage.removeItem(TOKEN_KEY); } catch (e) { console.warn('Could not remove token', e); }
            window.location.href = '../../login';
        }

        // Validate auth and load profile data
        (function validateAuthAndInit() {
            const AUTH_URL = API_URL + '/auth/perfil';

            const token = localStorage.getItem(TOKEN_KEY);
            if (!token) {
                window.location.href = '../../login';
                return;
            }

            fetch(AUTH_URL, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Unauthorized');
                return response.json();
            })
            .then(data => {
                // Reveal UI
                const content = document.querySelector('.content');
                if (content) content.style.display = '';

                // Fill in user data
                document.getElementById('username').value = data.usuario ?? data.username ?? data.name ?? '';
                document.getElementById('email').value = data.email ?? '';
            })
            .catch(err => {
                console.error('Auth validation failed:', err);
                try { localStorage.removeItem(TOKEN_KEY); } catch (e) {}
                window.location.href = '../../login';
            });
        })();

        // Handle user info form submission
        document.getElementById('formUserInfo').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const senhaAtual = document.getElementById('userPassword').value;
            
            if (!username || !email) {
                showMessage('messageUser', 'Por favor, preencha todos os campos.', 'error');
                return;
            }

            if (!senhaAtual) {
                showMessage('messageUser', 'A senha atual é obrigatória para salvar alterações.', 'error');
                return;
            }

            let token = localStorage.getItem(TOKEN_KEY);
            if (!token) {
                window.location.href = '../../login';
                return;
            }
            
            // Clean token just in case
            token = token.replace(/^"|"$/g, '').trim();

            try {
                const response = await fetch(API_URL + '/auth/perfil', {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        email: email,
                        senhaAtual: senhaAtual
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        if (data.error === 'Token não fornecido.' || data.error === 'Token inválido.') {
                             // Token issue
                             console.error('Token error:', data.error);
                             logout();
                             return;
                        }
                    }

                    // Handle different error cases
                    if (data.errors && Array.isArray(data.errors)) {
                        const errorMessages = data.errors.map(err => err.msg || err).join(', ');
                        showMessage('messageUser', errorMessages, 'error');
                    } else if (data.error) {
                        showMessage('messageUser', data.error, 'error');
                    } else {
                        showMessage('messageUser', 'Erro ao atualizar usuário.', 'error');
                    }
                    return;
                }

                // Success - update token if provided
                if (data.token) {
                    localStorage.setItem(TOKEN_KEY, data.token);
                }

                // Update displayed data
                if (data.admin) {
                    document.getElementById('username').value = data.admin.username || '';
                    document.getElementById('email').value = data.admin.email || '';
                }

                // Clear password field
                document.getElementById('userPassword').value = '';

                showMessage('messageUser', data.message || 'Usuário atualizado com sucesso!', 'success');
            } catch (err) {
                console.error('Error updating user:', err);
                showMessage('messageUser', 'Erro de conexão. Tente novamente.', 'error');
            }
        });

        // Handle password form submission
        document.getElementById('formPassword').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validation
            if (!currentPassword || !newPassword || !confirmPassword) {
                showMessage('messagePassword', 'Por favor, preencha todos os campos.', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showMessage('messagePassword', 'A nova senha e a confirmação não coincidem.', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showMessage('messagePassword', 'A nova senha deve ter pelo menos 6 caracteres.', 'error');
                return;
            }

            let token = localStorage.getItem(TOKEN_KEY);
            if (!token) {
                window.location.href = '../../login';
                return;
            }

            // Clean token just in case
            token = token.replace(/^"|"$/g, '').trim();

            try {
                const response = await fetch(API_URL + '/auth/perfil', {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        senhaAtual: currentPassword,
                        novaSenha: newPassword
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                         if (data.error === 'Token não fornecido.' || data.error === 'Token inválido.') {
                             // Token issue
                             console.error('Token error:', data.error);
                             logout();
                             return;
                        }
                    }

                    // Handle different error cases
                    if (data.errors && Array.isArray(data.errors)) {
                        const errorMessages = data.errors.map(err => err.msg || err).join(', ');
                        showMessage('messagePassword', errorMessages, 'error');
                    } else if (data.error) {
                        showMessage('messagePassword', data.error, 'error');
                    } else {
                        showMessage('messagePassword', 'Erro ao alterar senha.', 'error');
                    }
                    return;
                }

                // Success - update token if provided
                if (data.token) {
                    localStorage.setItem(TOKEN_KEY, data.token);
                }

                // Clear password fields
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';

                showMessage('messagePassword', data.message || 'Senha alterada com sucesso!', 'success');
            } catch (err) {
                console.error('Error changing password:', err);
                showMessage('messagePassword', 'Erro de conexão. Tente novamente.', 'error');
            }
        });
    </script>
    </body>
</html>
